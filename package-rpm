#!/bin/bash -x
#
# This script builds Varnish Cache in chroot from a tarball.
#
# Author: Lasse Karstensen <lkarsten@varnish-software.com>, March 2015.
set -o errexit

ELVER=${ELVER:-el7}
CHROOT="epel-${ELVER:2:1}-x86_64"
MOPT="--uniqueext=worker${EXECUTOR_NUMBER}"

rm -rf build
mkdir -p build
cd build

SOURCE=$(ls -1 ../sources/varnish-*.tar.gz)
tar xf $SOURCE

cp -r ../redhat/* .
# GIT_DIR=../redhat/.git git archive HEAD | tar xf -

ln $SOURCE `basename $SOURCE` 

# while debugging, disable make check since it takes 15-20 minutes to run.
sed -i -e 's/^make check/# make check/' *.spec

mock -r $CHROOT $MOPT --init
mock -v -r $CHROOT $MOPT --buildsrpm \
  -D "_smp_mflags -j10" \
  -D "dist .${ELVER}" \
  --spec *.spec \
  --source . \
  --resultdir ../rpm-build/varnish-4.1/${ELVER}

mock -r $CHROOT $MOPT --clean
mock -v -r $CHROOT $MOPT \
  -D "_smp_mflags -j10" \
  -D "dist .${ELVER}" \
  --resultdir ../rpm-build/varnish-4.1/${ELVER} \
  --rebuild ../rpm-build/varnish-4.1/${ELVER}/varnish*.src.rpm
