#!/bin/bash
#
# Build Debian and Ubuntu packages from a tarball.
#
# This is the script that our Jenkins/CI system runs. Yes, it is a bit messy.
#
# For running this on your own computer (trusty), see https://wiki.debian.org/mk-sbuild
# for information on setting up sbuild.
# Short version: 1) apt-get install ubuntu-dev-tools 2) mk-sbuild trusty
#
# To CHANGE the golden image: sudo schroot -c source:trusty-amd64 -u root
# To ENTER an image snapshot: schroot -c trusty-amd64
# To BUILD within a snapshot: sbuild -A -d trusty-amd64 PACKAGE*.dsc

if [[ -n "${JENKINS_HOME}" ]]; then
	set -x
	# Handle old chroot naming on our jenkins servers. Used in the bottom.
	chroot_postfix="-sbuild";
fi

set -o errexit

. common.sh

rm -rf build
mkdir -p build

SOURCE=$(ls -1 sources/varnish-*.tar.gz)  # XXX
findversion $SOURCE

# Make sure we use the same tarball each time.
if [[ -n "${DEBVERSION}" ]] && [[ ${DEBVERSION} -gt 1 ]]; then
	echo "DEBVERSION set, this is a release build. Using published tarball."
	rm $SOURCE
	./dl-source $V.$MINOR sources
	SOURCE=$(ls -1 sources/varnish-*.tar.gz)
	findversion $SOURCE
fi

tar xf ${SOURCE} -C build

cd build/varnish-*

cp -r ../../debian .
rm -f debian/.*.sw?    # Delete any vim temporary files.

ln ../../$SOURCE ../varnish_$V.$MINOR.orig.tar.gz

# Modify Section to suit our repository software.
sed -i -e "s|^Section: \([^/]*\)\$|Section: varnish-$V/\1|" debian/control

# Take version override set on Jenkins builds into account.
if [[ -n "${DEBVERSION}" ]]; then
	FULL_VERSION="$V.$MINOR-$DEBVERSION"
	dch -v "$FULL_VERSION" "Release build #$BUILD_NUMBER ID: $BUILD_ID"
else
	FULL_VERSION="$V.$MINOR-0${RELEASE}+daily+$(date +%Y%m%d.%H%M%S)"
	dch -v "$V.$MINOR-0${RELEASE}+daily+$(date +%Y%m%d.%H%M%S)" "Automatic build from git"
fi

dpkg-buildpackage -us -uc -S -j10
cd ..

# By now we are done setting up and building the source package.

export DEBIAN_OVERRIDE_BINARY_VERSION="$FULL_VERSION"
sbuild -v -A -c "trusty-amd64$chroot_postfix" -d "trusty" varnish_*.dsc
